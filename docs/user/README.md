# P3 用户手册

P3（P2P Port Proxy Platform）是一个基于 P2P 技术的端口转发平台，支持内网穿透、P2P 打洞和端口转发管理。本手册将指导您如何安装、配置和使用 P3。

## 目录

1. [安装](#安装)
2. [快速入门](#快速入门)
3. [设备管理](#设备管理)
4. [应用管理](#应用管理)
5. [端口转发](#端口转发)
6. [常见问题](#常见问题)

## 安装

### 服务端安装

服务端需要部署在具有公网 IP 的服务器上。

#### 使用 Docker 安装（推荐）

```bash
# 克隆仓库
git clone https://github.com/senma231/p3.git
cd p3

# 使用 Docker Compose 启动服务
cd docker
docker-compose up -d
```

#### 手动安装

```bash
# 克隆仓库
git clone https://github.com/senma231/p3.git
cd p3

# 构建服务端
cd server
go build -o p3-server ./cmd

# 运行服务端
./p3-server -config config.yaml
```

### 客户端安装

客户端支持 Windows、Linux、Mac OS 等多种平台。

#### Windows

1. 下载最新的 Windows 客户端安装包
2. 双击安装包进行安装
3. 安装完成后，在系统托盘中找到 P3 图标

#### Linux

```bash
# 下载客户端
wget https://example.com/p3-client-linux-amd64.tar.gz
tar -xzf p3-client-linux-amd64.tar.gz

# 安装为系统服务
cd p3-client
sudo ./p3-client -install -node YOUR_NODE_NAME -token YOUR_TOKEN
```

#### Mac OS

1. 下载最新的 Mac OS 客户端安装包
2. 双击安装包进行安装
3. 安装完成后，在系统菜单栏中找到 P3 图标

## 快速入门

### 1. 注册账号

1. 打开 Web 管理平台（http://your-server-ip）
2. 点击"注册"按钮
3. 填写用户名、密码和邮箱
4. 点击"注册"完成账号创建

### 2. 添加设备

1. 登录 Web 管理平台
2. 进入"设备管理"页面
3. 点击"添加设备"按钮
4. 填写设备名称，获取设备令牌
5. 在需要添加的设备上安装客户端，并使用设备令牌进行配置

### 3. 创建 P2P 应用

1. 进入"应用管理"页面
2. 点击"创建应用"按钮
3. 填写应用信息：
   - 应用名称
   - 协议类型（TCP/UDP）
   - 本地监听端口
   - 目标设备
   - 目标端口
   - 目标主机
4. 点击"创建"按钮

### 4. 使用 P2P 应用

创建应用后，您可以通过本地监听端口访问远程服务。例如，如果您创建了一个将本地 23389 端口映射到远程 3389 端口的应用，您可以通过以下方式使用远程桌面：

1. 打开远程桌面连接（mstsc）
2. 输入 `127.0.0.1:23389`
3. 点击"连接"

## 设备管理

### 设备状态

设备状态分为以下几种：

- **在线**：设备已连接到服务器，可以正常使用
- **离线**：设备未连接到服务器，无法使用

### 设备操作

- **重启**：重启设备上的 P3 客户端
- **升级**：升级设备上的 P3 客户端到最新版本
- **删除**：从系统中删除设备

### NAT 类型

P3 会自动检测设备的 NAT 类型，包括：

- **无 NAT（公网 IP）**：设备具有公网 IP，可以直接访问
- **完全锥形 NAT**：最容易穿透的 NAT 类型
- **受限锥形 NAT**：较容易穿透的 NAT 类型
- **端口受限锥形 NAT**：较难穿透的 NAT 类型
- **对称型 NAT**：最难穿透的 NAT 类型

## 应用管理

### 应用类型

P3 支持以下类型的应用：

- **TCP 应用**：如远程桌面、SSH、Web 服务等
- **UDP 应用**：如 VPN、游戏、视频会议等

### 应用状态

应用状态分为以下几种：

- **运行中**：应用已启动，可以正常使用
- **已停止**：应用已停止，无法使用
- **错误**：应用启动失败或运行出错

### 应用操作

- **启动**：启动应用
- **停止**：停止应用
- **编辑**：修改应用配置
- **删除**：删除应用

## 端口转发

### 转发规则

转发规则定义了如何将本地端口映射到远程端口。规则包含以下信息：

- **协议**：TCP 或 UDP
- **源端口**：本地监听端口
- **目标主机**：远程主机地址
- **目标端口**：远程主机端口
- **描述**：规则描述
- **状态**：启用或禁用

### 转发统计

P3 会记录每个转发规则的统计信息，包括：

- **发送字节数**：通过该规则发送的数据量
- **接收字节数**：通过该规则接收的数据量
- **连接数**：通过该规则建立的连接数
- **开始时间**：规则启动时间

## 常见问题

### 1. 无法连接到远程设备

可能的原因：

- 远程设备离线
- NAT 类型不兼容，无法建立 P2P 连接
- 防火墙阻止了连接

解决方法：

- 检查远程设备是否在线
- 尝试使用中继模式连接
- 检查防火墙设置

### 2. 连接速度慢

可能的原因：

- 使用了中继连接而非直接连接
- 网络带宽限制
- 网络质量差

解决方法：

- 检查连接类型，尽量使用直接连接
- 增加共享带宽限制
- 使用更好的网络环境

### 3. 客户端无法启动

可能的原因：

- 配置错误
- 端口被占用
- 权限不足

解决方法：

- 检查配置文件
- 更换端口
- 使用管理员权限运行
